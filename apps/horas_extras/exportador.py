# apps/horas_extras/exportador.py\nimport openpyxl\nfrom openpyxl.utils import get_column_letter\nfrom openpyxl.styles import Font, Alignment\nfrom django.http import HttpResponse\nfrom .utils import ReportesHorasExtras\n\n\nclass ExportadorReportes:\n    \"\"\"Exportador de reportes de horas extras y recargos a Excel\"\"\"\n\n    @classmethod\n    def exportar_excel_empleado(cls, reporte):\n        \"\"\"Exporta a Excel el reporte de un solo empleado\"\"\"\n        empleado = reporte['empleado']\n        periodo = reporte['periodo']\n        turnos = reporte['turnos']\n        resumen = reporte['resumen']\n\n        wb = openpyxl.Workbook()\n        ws = wb.active\n        ws.title = 'Reporte'\n\n        # Títulos principales\n        ws.merge_cells('A1:G1')\n        ws['A1'] = f'Reporte de Horas Extras y Recargos'\n        ws['A1'].font = Font(bold=True, size=14)\n        ws['A1'].alignment = Alignment(horizontal='center')\n\n        ws.merge_cells('A2:G2')\n        ws['A2'] = f'Empleado: {empleado.nombres} {empleado.apellidos} | Periodo: {periodo}'\n        ws['A2'].font = Font(bold=True)\n        ws['A2'].alignment = Alignment(horizontal='center')\n\n        # Encabezados\n        headers = [\n            'Fecha', 'Turno', 'Horas Trabajadas', 'Horas Extras', 'Recargos ($)', 'Extras ($)', 'Total Día ($)'\n        ]\n        ws.append(headers)\n        for col_num in range(1, len(headers)+1):\n            ws.cell(row=3, column=col_num).font = Font(bold=True)\n            ws.cell(row=3, column=col_num).alignment = Alignment(horizontal='center')\n\n        # Datos de turnos\n        row = 4\n        for turno in turnos:\n            fecha = turno.fecha.strftime('%Y-%m-%d')\n            turno_nombre = turno.tipo_turno.get_nombre_display()\n            horas_trabajadas = float(turno.horas_trabajadas)\n            horas_extras = float(turno.horas_extras)\n            recargos = float(turno.calculo.total_recargos) if hasattr(turno, 'calculo') else 0.0\n            extras = float(turno.calculo.total_horas_extras) if hasattr(turno, 'calculo') else 0.0\n            total_dia = float(turno.calculo.total_a_pagar) if hasattr(turno, 'calculo') else 0.0\n\n            ws.append([fecha, turno_nombre, horas_trabajadas, horas_extras, recargos, extras, total_dia])\n            row += 1\n\n        # Resumen\n        resumen_labels = [\n            '', '', 'TOTAL:', resumen['total_horas'], resumen['total_horas_extras'], resumen['total_recargos'], resumen['total_horas_extras_valor'], resumen['total_a_pagar']\n        ]\n        ws.append([])\n        ws.append(['', '', 'Total Horas:', resumen['total_horas']])\n        ws.append(['', '', 'Total Extras:', resumen['total_horas_extras']])\n        ws.append(['', '', 'Total Recargos ($):', resumen['total_recargos']])\n        ws.append(['', '', 'Total Extras ($):', resumen['total_horas_extras_valor']])\n        ws.append(['', '', 'Total a Pagar ($):', resumen['total_a_pagar']])\n\n        # Ajustar anchos de columna\n        for col in range(1, len(headers) + 1):\n            ws.column_dimensions[get_column_letter(col)].width = 18\n\n        # Preparar respuesta HTTP\n        response = HttpResponse(content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')\n        filename = f'ReporteHorasExtrasRecargos_{empleado.nombres}_{empleado.apellidos}_{periodo}.xlsx'\n        response['Content-Disposition'] = f'attachment; filename=\"{filename}\"'\n        wb.save(response)\n        return response\n\n    @classmethod\n    def exportar_excel_todos(cls, reporte):\n        \"\"\"Exporta a Excel el reporte de todos los empleados\"\"\"\n        wb = openpyxl.Workbook()\n        ws = wb.active\n        ws.title = 'Reporte General'\n\n        ws.merge_cells('A1:H1')\n        ws['A1'] = 'Reporte General de Horas Extras y Recargos'\n        ws['A1'].font = Font(bold=True, size=14)\n        ws['A1'].alignment = Alignment(horizontal='center')\n\n        ws.merge_cells('A2:H2')\n        ws['A2'] = f'Periodo: {reporte[\"periodo\"]}'\n        ws['A2'].font = Font(bold=True)\n        ws['A2'].alignment = Alignment(horizontal='center')\n\n        # Encabezados\n        headers = ['Empleado', 'Total Turnos', 'Horas Trabajadas', 'Horas Extras', 'Recargos ($)', 'Extras ($)', 'Total a Pagar ($)']\n        ws.append(headers)\n        for col_num in range(1, len(headers)+1):\n            ws.cell(row=3, column=col_num).font = Font(bold=True)\n            ws.cell(row=3, column=col_num).alignment = Alignment(horizontal='center')\n\n        # Datos por empleado\n        row = 4\n        for empleado_reporte in reporte['empleados']:\n            emp = empleado_reporte['empleado']\n            resumen = empleado_reporte['resumen']\n            ws.append([\n                f\"{emp.nombres} {emp.apellidos}\",\n                resumen['total_turnos'],\n                resumen['total_horas'],\n                resumen['total_horas_extras'],\n                resumen['total_recargos'],\n                resumen['total_horas_extras_valor'],\n                resumen['total_a_pagar'],\n            ])\n            row += 1\n\n        # Totales generales\n        totales = reporte['totales']\n        ws.append([])\n        ws.append(['', 'TOTAL:', totales['total_turnos'], totales['total_horas'], totales['total_horas_extras'], '', '', totales['total_a_pagar']])\n\n        for col in range(1, len(headers) + 1):\n            ws.column_dimensions[get_column_letter(col)].width = 22\n\n        # Preparar respuesta HTTP\n        response = HttpResponse(content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')\n        filename = f'ReporteHorasExtrasRecargos_{reporte[\"periodo\"]}.xlsx'\n        response['Content-Disposition'] = f'attachment; filename=\"{filename}\"'\n        wb.save(response)\n        return response\n